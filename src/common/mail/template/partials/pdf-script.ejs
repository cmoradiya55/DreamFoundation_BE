<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
    async function downloadPDF(dataUrl) {
        const loadingEl = document.getElementById('loading');
        if (loadingEl) loadingEl.style.display = 'block';

        try {
            const response = await fetch(dataUrl);
            if (!response.ok) throw new Error('Failed to fetch PDF data');
            
            const result = await response.json();
            const pdfData = result.data;

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            let yPosition = 20;

            // Title
            doc.setFontSize(20);
            doc.setTextColor(102, 126, 234);
            doc.text(pdfData.documentTitle || 'Document', 20, yPosition);
            yPosition += 15;

            // Line separator
            doc.setDrawColor(102, 126, 234);
            doc.setLineWidth(0.5);
            doc.line(20, yPosition, 190, yPosition);
            yPosition += 10;

            // Metadata
            doc.setFontSize(10);
            doc.setTextColor(100, 100, 100);
            doc.text(`Generated: ${new Date().toLocaleDateString()}`, 20, yPosition);
            yPosition += 7;
            if (pdfData.documentId) {
                doc.text(`Document ID: ${pdfData.documentId}`, 20, yPosition);
                yPosition += 7;
            }
            yPosition += 5;

            // Customer Info
            if (pdfData.customerInfo) {
                doc.setFontSize(14);
                doc.setTextColor(0, 0, 0);
                doc.text('Customer Information', 20, yPosition);
                yPosition += 8;

                doc.setFontSize(11);
                doc.setTextColor(60, 60, 60);
                
                if (pdfData.customerInfo.name) {
                    doc.text(`Name: ${pdfData.customerInfo.name}`, 25, yPosition);
                    yPosition += 7;
                }
                if (pdfData.customerInfo.email) {
                    doc.text(`Email: ${pdfData.customerInfo.email}`, 25, yPosition);
                    yPosition += 7;
                }
                if (pdfData.customerInfo.phone) {
                    doc.text(`Phone: ${pdfData.customerInfo.phone}`, 25, yPosition);
                    yPosition += 7;
                }
                if (pdfData.customerInfo.address) {
                    doc.text(`Address: ${pdfData.customerInfo.address}`, 25, yPosition);
                    yPosition += 7;
                }
                yPosition += 5;
            }

            // Content
            if (pdfData.content) {
                doc.setFontSize(14);
                doc.setTextColor(0, 0, 0);
                doc.text('Details', 20, yPosition);
                yPosition += 8;

                doc.setFontSize(11);
                doc.setTextColor(60, 60, 60);
                
                const contentText = pdfData.content.replace(/<[^>]*>/g, '');
                const splitContent = doc.splitTextToSize(contentText, 170);
                doc.text(splitContent, 25, yPosition);
                yPosition += (splitContent.length * 7) + 5;
            }

            // Items table
            if (pdfData.items && pdfData.items.length > 0) {
                if (yPosition > 250) {
                    doc.addPage();
                    yPosition = 20;
                }

                doc.setFontSize(14);
                doc.setTextColor(0, 0, 0);
                doc.text('Items', 20, yPosition);
                yPosition += 10;

                // Headers
                doc.setFillColor(102, 126, 234);
                doc.rect(20, yPosition, 170, 10, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(10);
                doc.text('Description', 25, yPosition + 7);
                doc.text('Qty', 110, yPosition + 7);
                doc.text('Price', 135, yPosition + 7);
                doc.text('Total', 165, yPosition + 7);
                yPosition += 10;

                // Rows
                doc.setTextColor(60, 60, 60);
                let total = 0;
                pdfData.items.forEach((item, index) => {
                    const rowTotal = item.quantity * item.unitPrice;
                    total += rowTotal;

                    if (index % 2 === 0) {
                        doc.setFillColor(248, 249, 250);
                        doc.rect(20, yPosition, 170, 8, 'F');
                    }

                    doc.text(item.description.substring(0, 30), 25, yPosition + 6);
                    doc.text(item.quantity.toString(), 110, yPosition + 6);
                    doc.text(`$${item.unitPrice.toFixed(2)}`, 135, yPosition + 6);
                    doc.text(`$${rowTotal.toFixed(2)}`, 165, yPosition + 6);
                    yPosition += 8;
                });

                // Total
                yPosition += 5;
                doc.setFontSize(12);
                doc.setTextColor(0, 0, 0);
                doc.text(`Total: $${total.toFixed(2)}`, 165, yPosition, { align: 'right' });
            }

            // Notes
            if (pdfData.notes) {
                if (yPosition > 260) {
                    doc.addPage();
                    yPosition = 20;
                } else {
                    yPosition += 10;
                }

                doc.setFillColor(255, 243, 205);
                doc.rect(20, yPosition, 170, 20, 'F');
                doc.setFontSize(10);
                doc.setTextColor(133, 100, 4);
                const noteText = doc.splitTextToSize(pdfData.notes, 160);
                doc.text(noteText, 25, yPosition + 7);
            }

            // Footer on all pages
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(9);
                doc.setTextColor(150, 150, 150);
                doc.text(
                    `${pdfData.companyName || 'Your Company'} | Page ${i} of ${pageCount}`,
                    105,
                    285,
                    { align: 'center' }
                );
            }

            // Save
            const fileName = pdfData.fileName || `document-${Date.now()}.pdf`;
            doc.save(fileName);

            if (loadingEl) loadingEl.style.display = 'none';
            alert('PDF downloaded successfully!');
        } catch (error) {
            console.error('Error generating PDF:', error);
            if (loadingEl) loadingEl.style.display = 'none';
            alert('Failed to generate PDF. Please try again.');
        }
    }
</script>