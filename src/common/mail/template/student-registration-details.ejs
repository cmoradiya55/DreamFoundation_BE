<%
// ==========================================
// 1. DATA PRE-PROCESSING & DEFAULTS
// ==========================================

// Student Data
const studentData = {
  full_name: typeof full_name !== 'undefined' ? full_name : 'N/A',
  registration_number: typeof registration_number !== 'undefined' ? registration_number : 'REG-PENDING',
  student_class: typeof student_class !== 'undefined' ? student_class : 'N/A',
  date_of_birth: typeof date_of_birth !== 'undefined' ? date_of_birth : new Date().toISOString(),
  gender: typeof gender !== 'undefined' ? gender : 'N/A',
  blood_group: typeof blood_group !== 'undefined' ? blood_group : 'N/A',
};

// Age Calculation Logic
let age = 'N/A';
if (studentData.date_of_birth !== 'N/A') {
    try {
        const dob = new Date(studentData.date_of_birth);
        const diff_ms = Date.now() - dob.getTime();
        const age_dt = new Date(diff_ms); 
        age = Math.abs(age_dt.getUTCFullYear() - 1970);
    } catch (e) {
        age = 'N/A';
    }
}

// Parent Data
const parentData = {
  father_name: typeof father_name !== 'undefined' ? father_name : 'N/A',
  father_occupation: typeof father_occupation !== 'undefined' ? father_occupation : 'N/A',
  father_email: typeof father_email !== 'undefined' ? father_email : 'N/A',
  father_mobile: typeof father_mobile !== 'undefined' ? father_mobile : 'N/A',
  father_code: typeof father_mobile_country_code !== 'undefined' ? father_mobile_country_code : '91',
  
  mother_name: typeof mother_name !== 'undefined' ? mother_name : 'N/A',
  mother_occupation: typeof mother_occupation !== 'undefined' ? mother_occupation : 'N/A',
  mother_email: typeof mother_email !== 'undefined' ? mother_email : 'N/A',
  mother_mobile: typeof mother_mobile !== 'undefined' ? mother_mobile : 'N/A',
  mother_code: typeof mother_mobile_country_code !== 'undefined' ? mother_mobile_country_code : '91',

  emergency_contact_name: typeof emergency_contact_name !== 'undefined' ? emergency_contact_name : 'N/A',
  emergency_contact_relation: typeof emergency_contact_relation !== 'undefined' ? emergency_contact_relation : 'N/A',
  emergency_mobile: typeof emergency_contact_phone !== 'undefined' ? emergency_contact_phone : 'N/A',
  emergency_code: typeof emergency_mobile_country_code !== 'undefined' ? emergency_mobile_country_code : '91',
};

// Address Data
const addressData = {
  address_line_1: typeof address_line_1 !== 'undefined' ? address_line_1 : 'N/A',
  address_line_2: typeof address_line_2 !== 'undefined' && address_line_2 ? address_line_2 : null,
  landmark: typeof landmark !== 'undefined' && landmark ? landmark : 'N/A',
  city: typeof city !== 'undefined' ? city : 'N/A',
  pincode: typeof pincode !== 'undefined' ? pincode : 'N/A'
};

// Medical Data
const medicalData = {
  has_allergies: typeof has_allergies !== 'undefined' ? has_allergies : false,
  allergies: typeof allergies !== 'undefined' && allergies ? allergies : null,
  has_special_needs: typeof has_special_needs !== 'undefined' ? has_special_needs : false,
  special_needs: typeof special_needs !== 'undefined' && special_needs ? special_needs : null
};

// Meta & Documents
const docData = typeof documents !== 'undefined' ? documents : [];
const metaData = {
    fees_acknowledged: typeof fees_acknowledged !== 'undefined' ? fees_acknowledged : false,
    declaration_accepted: typeof declaration_accepted !== 'undefined' ? declaration_accepted : false,
    terms_accepted: typeof terms_accepted !== 'undefined' ? terms_accepted : false,
    created_at: typeof created_at !== 'undefined' ? created_at : new Date().toISOString()
};

// Institution Config
const institution = {
    name: typeof institution_name !== 'undefined' ? institution_name : 'VisioniteTech Academy'
};
%>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admission Form - <%= institution.name %></title>
    <style>
        /* Base Reset */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        
        body {
            padding: 20px;
            color: #333;
            line-height: 1.5;
            font-size: 14px;
            background-color: #fff;
        }
        
        /* Container */
        .pdf-container {
            max-width: 800px;
            margin: 0 auto;
            border: 1px solid #ddd;
            padding: 30px;
            position: relative;
            background: #fff;
        }
        
        /* Header */
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #73A997;
        }
        
        .institution-name { color: #1E4034; font-size: 28px; margin-bottom: 5px; font-weight: bold; }
        .form-title { color: #214236; font-size: 22px; margin-bottom: 10px; }
        
        /* Photo Box */
        .student-photo {
            position: absolute;
            top: 30px;
            right: 30px;
            width: 110px;
            height: 130px;
            border: 1px solid #ccc;
            background-color: #f8f8f8;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #aaa;
            font-size: 12px;
            text-align: center;
        }
        
        /* Sections */
        .section { margin-bottom: 25px; page-break-inside: avoid; }
        
        .section-title {
            background-color: #1E4034;
            color: white;
            padding: 8px 15px;
            margin-bottom: 15px;
            border-radius: 4px;
            font-size: 15px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        /* Grid System */
        .form-row { display: flex; flex-wrap: wrap; margin-bottom: 12px; }
        .form-group { padding: 0 10px; margin-bottom: 5px; }
        .form-group.half { width: 50%; }
        .form-group.full { width: 100%; }
        .form-group.third { width: 33.33%; }
        
        /* Fields */
        .label {
            font-weight: 700;
            color: #1C3D31;
            margin-bottom: 4px;
            display: block;
            font-size: 12px;
        }
        
        .value {
            padding: 6px 10px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            background-color: #fcfcfc;
            min-height: 32px;
            display: flex;
            align-items: center;
        }
        
        /* Declaration & Signature */
        .declaration {
            background-color: #f0f7f4;
            padding: 15px;
            border-left: 4px solid #73A997;
            margin: 20px 0;
            font-size: 12px;
            text-align: justify;
        }
        
        .signature-area { margin-top: 50px; padding-top: 10px; }
        .signature-line {
            border-top: 1px solid #333;
            width: 250px;
            text-align: center;
            padding-top: 5px;
            font-weight: bold;
            float: right;
        }
        
        /* Footer */
        .footer {
            margin-top: 60px;
            text-align: center;
            font-size: 10px;
            color: #888;
            border-top: 1px solid #eee;
            padding-top: 15px;
            clear: both;
        }
        
        /* Print Overrides */
        @media print {
            body { padding: 0; background-color: #fff; }
            .pdf-container { border: none; padding: 20px; max-width: 100%; }
            .section-title { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
        }
    </style>
</head>
<body>

<div class="pdf-container">
    
    <div class="header">
        <h1 class="institution-name"><%= COMPANY.NAME + " (" + COMPANY.SUB_COMPANY_1 + ")" %></h1>
        <h2 class="form-title">Student Admission Form</h2>
        <p>Registration No: <strong><%= studentData.registration_number %></strong></p>
    </div>
    <div class="section">
        <div class="section-title">Personal Information</div>
        <div class="form-row">
            <div class="form-group half">
                <div class="label">Full Name</div>
                <div class="value"><%= studentData.full_name %></div>
            </div>
            <div class="form-group half">
                <div class="label">Date of Birth</div>
                <div class="value"><%= new Date(studentData.date_of_birth).toLocaleDateString() %></div>
            </div>
        </div>
        <div class="form-row">
            <div class="form-group half">
                <div class="label">Age</div>
                <div class="value"><%= age %> Years</div>
            </div>
            <div class="form-group half">
                <div class="label">Gender</div>
                <div class="value"><%= studentData.gender %></div>
            </div>
        </div>
        <div class="form-row">
            <div class="form-group half">
                <div class="label">Class Seeking</div>
                <div class="value"><%= studentData.student_class %></div>
            </div>
            <div class="form-group half">
                <div class="label">Blood Group</div>
                <div class="value"><%= studentData.blood_group %></div>
            </div>
        </div>
    </div>

    <div class="section">
        <div class="section-title">Father's Information</div>
        <div class="form-row">
            <div class="form-group half">
                <div class="label">Father's Name</div>
                <div class="value"><%= parentData.father_name %></div>
            </div>
            <div class="form-group half">
                <div class="label">Occupation</div>
                <div class="value"><%= parentData.father_occupation %></div>
            </div>
        </div>
        <div class="form-row">
            <div class="form-group half">
                <div class="label">Mobile Number</div>
                <div class="value"><%= parentData.father_mobile %></div>
            </div>
            <div class="form-group half">
                <div class="label">Email Address</div>
                <div class="value"><%= parentData.father_email %></div>
            </div>
        </div>
    </div>

    <div class="section">
        <div class="section-title">Mother's Information</div>
        <div class="form-row">
            <div class="form-group half">
                <div class="label">Mother's Name</div>
                <div class="value"><%= parentData.mother_name %></div>
            </div>
            <div class="form-group half">
                <div class="label">Occupation</div>
                <div class="value"><%= parentData.mother_occupation %></div>
            </div>
        </div>
        <div class="form-row">
            <div class="form-group half">
                <div class="label">Mobile Number</div>
                <div class="value"><%= parentData.mother_mobile %></div>
            </div>
            <div class="form-group half">
                <div class="label">Email Address</div>
                <div class="value"><%= parentData.mother_email %></div>
            </div>
        </div>
    </div>

    <div class="section">
        <div class="section-title">Address Details</div>
        <div class="form-row">
            <div class="form-group full">
                <div class="label">Address Line 1</div>
                <div class="value"><%= addressData.address_line_1 %></div>
            </div>
        </div>
        <% if (addressData.address_line_2) { %>
        <div class="form-row">
            <div class="form-group full">
                <div class="label">Address Line 2</div>
                <div class="value"><%= addressData.address_line_2 %></div>
            </div>
        </div>
        <% } %>
        <div class="form-row">
            <div class="form-group third">
                <div class="label">Landmark</div>
                <div class="value"><%= addressData.landmark %></div>
            </div>
            <div class="form-group third">
                <div class="label">City</div>
                <div class="value"><%= addressData.city %></div>
            </div>
            <div class="form-group third">
                <div class="label">Pincode</div>
                <div class="value"><%= addressData.pincode %></div>
            </div>
        </div>
    </div>

    <div class="section">
        <div class="section-title">Emergency & Medical</div>
        <div class="form-row">
            <div class="form-group half">
                <div class="label">Emergency Contact</div>
                <div class="value"><%= parentData.emergency_contact_name %> (<%= parentData.emergency_contact_relation %>)</div>
            </div>
            <div class="form-group half">
                <div class="label">Emergency Mobile</div>
                <div class="value"><%= parentData.emergency_mobile %></div>
            </div>
        </div>
        <div class="form-row">
            <div class="form-group half">
                <div class="label">Known Allergies</div>
                <div class="value">
                    <%= medicalData.has_allergies ? medicalData.allergies : 'None' %>
                </div>
            </div>
            <div class="form-group half">
                <div class="label">Special Needs</div>
                <div class="value">
                    <%= medicalData.has_special_needs ? medicalData.special_needs : 'None' %>
                </div>
            </div>
        </div>
    </div>

    <!-- <div class="section">
        <div class="section-title">Uploaded Documents</div>
        <div class="form-row">
            <div class="form-group full">
                <div class="value" style="display: block; padding: 10px;">
                    <% if (docData && docData.length > 0) { %>
                        <ul style="padding-left: 20px; margin: 0;">
                        <% docData.forEach(function(doc) { %>
                            <li style="margin-bottom: 5px;">
                                <strong><%= doc.document_type || 'Document' %>:</strong> 
                                <span style="color: #555;"><%= doc.document_url || 'Link' %></span>
                            </li>
                        <% }); %>
                        </ul>
                    <% } else { %>
                        <span style="color: #999;">No documents were attached to this application.</span>
                    <% } %>
                </div>
            </div>
        </div>
    </div> -->

    <div class="section">
        <div class="section-title">Declaration</div>
        <div class="declaration">
            <p>I/We hereby declare that the information provided in this admission form is true and correct to the best of my/our knowledge. I/We understand that providing false information may result in the cancellation of admission.</p>
            <br>
            <p>
                <strong>Terms Accepted:</strong> <%= metaData.terms_accepted ? 'YES' : 'NO' %> &nbsp;|&nbsp; 
                <strong>Fees Policy Acknowledged:</strong> <%= metaData.fees_acknowledged ? 'YES' : 'NO' %>
                <strong>Declaration Accepted:</strong> <%= metaData.declaration_accepted ? 'YES' : 'NO' %>
            </p>
        </div>

        <!-- <div class="signature-area">
            <div class="signature-line">Parent / Guardian Signature</div>
        </div> -->
    </div>

    <div class="footer">
        <p>Generated by <%= COMPANY.NAME %> System on <%= new Date().toLocaleString() %></p>
        <p>Ref ID: <%= studentData.registration_number %></p>
    </div>

</div>

</body>
</html>