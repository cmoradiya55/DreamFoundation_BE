<%
// ==========================================
// 1. DATA PRE-PROCESSING & DEFAULTS
// ==========================================

// Helper to safely flatten arrays if they come in nested (e.g. [[Obj], [Obj]])
const safeArray = (arr) => {
    if (typeof arr === 'undefined' || !Array.isArray(arr)) return [];
    return arr.flat();
};

// Teacher Personal Data
const teacherData = {
    full_name: typeof full_name !== 'undefined' ? full_name : 'N/A',
    registration_number: typeof registration_number !== 'undefined' ? registration_number : 'REG-PENDING',
    gender: typeof gender !== 'undefined' ? gender : 'N/A',
    marital_status: typeof marital_status !== 'undefined' ? marital_status : 'N/A',
    date_of_birth: typeof date_of_birth !== 'undefined' ? date_of_birth : new Date().toISOString(),
    email: typeof email !== 'undefined' ? email : 'N/A',
    mobile: typeof mobile !== 'undefined' ? mobile : 'N/A',
    country_code: typeof country_code !== 'undefined' ? country_code : '91',
};

// Age Calculation
let age = 'N/A';
if (teacherData.date_of_birth !== 'N/A') {
    try {
        const dob = new Date(teacherData.date_of_birth);
        const diff_ms = Date.now() - dob.getTime();
        const age_dt = new Date(diff_ms); 
        age = Math.abs(age_dt.getUTCFullYear() - 1970);
    } catch (e) { age = 'N/A'; }
}

// Address Data
const addressData = {
    address_line_1: typeof address_line_1 !== 'undefined' ? address_line_1 : 'N/A',
    address_line_2: typeof address_line_2 !== 'undefined' && address_line_2 ? address_line_2 : null,
    landmark: typeof landmark !== 'undefined' && landmark ? landmark : 'N/A',
    city: typeof city !== 'undefined' ? city : 'N/A',
    pincode: typeof pincode !== 'undefined' ? pincode : 'N/A'
};

// Skills / Boolean Flags
const skillsData = {
    has_basic_computer_knowledge: typeof has_basic_computer_knowledge !== 'undefined' ? has_basic_computer_knowledge : false,
    know_ms_office: typeof know_ms_office !== 'undefined' ? know_ms_office : false,
    know_online_teaching_tools: typeof know_online_teaching_tools !== 'undefined' ? know_online_teaching_tools : false,
};

// Dynamic Arrays - Flattened to fix your nesting issue
const experienceData = safeArray(typeof experiences !== 'undefined' ? experiences : []);
const qualificationData = safeArray(typeof qualifications !== 'undefined' ? qualifications : []);
const docData = safeArray(typeof documents !== 'undefined' ? documents : []);

// Meta Data
const metaData = {
    declaration_accepted: typeof declaration_accepted !== 'undefined' ? declaration_accepted : false,
    created_at: typeof created_at !== 'undefined' ? created_at : new Date().toISOString()
};

// Institution Config
const institution = {
    name: typeof institution_name !== 'undefined' ? institution_name : 'VisioniteTech Academy'
};
%>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher Registration - <%= institution.name %></title>
    <style>
        /* =========================================
           REUSING EXACT CSS FROM STUDENT TEMPLATE
           FOR BRAND CONSISTENCY
           ========================================= */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        
        body {
            padding: 20px;
            color: #333;
            line-height: 1.5;
            font-size: 14px;
            background-color: #fff;
        }
        
        .pdf-container {
            max-width: 800px;
            margin: 0 auto;
            border: 1px solid #ddd;
            padding: 30px;
            position: relative;
            background: #fff;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #73A997;
        }
        
        .institution-name { color: #1E4034; font-size: 28px; margin-bottom: 5px; font-weight: bold; }
        .form-title { color: #214236; font-size: 22px; margin-bottom: 10px; }
        
        .photo-box {
            position: absolute;
            top: 30px;
            right: 30px;
            width: 110px;
            height: 130px;
            border: 1px solid #ccc;
            background-color: #f8f8f8;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #aaa;
            font-size: 12px;
            text-align: center;
        }
        
        .section { margin-bottom: 25px; page-break-inside: avoid; }
        
        .section-title {
            background-color: #1E4034;
            color: white;
            padding: 8px 15px;
            margin-bottom: 15px;
            border-radius: 4px;
            font-size: 15px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .form-row { display: flex; flex-wrap: wrap; margin-bottom: 12px; }
        .form-group { padding: 0 10px; margin-bottom: 5px; }
        .form-group.half { width: 50%; }
        .form-group.full { width: 100%; }
        .form-group.third { width: 33.33%; }
        
        .label {
            font-weight: 700;
            color: #1C3D31;
            margin-bottom: 4px;
            display: block;
            font-size: 12px;
        }
        
        .value {
            padding: 6px 10px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            background-color: #fcfcfc;
            min-height: 32px;
            display: flex;
            align-items: center;
        }

        /* TABLE STYLES FOR EXPERIENCE/QUALIFICATION */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 13px;
        }
        .data-table th, .data-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .data-table th {
            background-color: #f0f7f4;
            color: #1E4034;
            font-weight: 600;
        }
        
        .declaration {
            background-color: #f0f7f4;
            padding: 15px;
            border-left: 4px solid #73A997;
            margin: 20px 0;
            font-size: 12px;
            text-align: justify;
        }

        /* --- NEW STYLES FOR DOCUMENT APPENDING --- */
        .page-break { page-break-before: always; }
        .document-preview { margin-top: 20px; text-align: center; page-break-inside: avoid; }
        .document-preview img { max-width: 100%; max-height: 900px; border: 1px solid #ddd; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .document-fallback { padding: 40px; background: #f8f9fa; border: 2px dashed #dee2e6; text-align: center; color: #6c757d; }
        
        .footer {
            margin-top: 60px;
            text-align: center;
            font-size: 10px;
            color: #888;
            border-top: 1px solid #eee;
            padding-top: 15px;
            clear: both;
        }
        
        @media print {
            body { padding: 0; background-color: #fff; }
            .pdf-container { border: none; padding: 20px; max-width: 100%; }
            .section-title { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .data-table th { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .page-break { page-break-before: always; }
        }
    </style>
</head>
<body>

<div class="pdf-container">
    
    <div class="header">
        <h1 class="institution-name"><%= COMPANY.NAME + "(" + COMPANY.SUB_COMPANY_1 + ")" %></h1>
        <h2 class="form-title">Teacher Application Form</h2>
        <p>Registration No: <strong><%= teacherData.registration_number %></strong></p>
    </div>

    
    <div class="photo-box">
        <% 
        const passportDoc = docData.find(doc => doc && doc.document_type === 'passportSizePhoto');
        %>
        
        <% if (passportDoc && passportDoc.document_url) { %>
            <img src="<%= passportDoc.document_url %>" alt="Passport Photo" style="width: 100%; height: 100%; object-fit: cover;" />
        <% } else { %>
            Passport Size<br>Photo
        <% } %>
    </div>

    <div class="section">
        <div class="section-title">Personal Information</div>
        <div class="form-row">
            <div class="form-group half">
                <div class="label">Full Name</div>
                <div class="value"><%= teacherData.full_name %></div>
            </div>
            <div class="form-group half">
                <div class="label">Date of Birth</div>
                <div class="value"><%= new Date(teacherData.date_of_birth).toLocaleDateString() %> (Age: <%= age %>)</div>
            </div>
        </div>
        <div class="form-row">
            <div class="form-group half">
                <div class="label">Gender</div>
                <div class="value"><%= teacherData.gender %></div>
            </div>
            <div class="form-group half">
                <div class="label">Marital Status</div>
                <div class="value"><%= teacherData.marital_status %></div>
            </div>
        </div>
        <div class="form-row">
            <div class="form-group half">
                <div class="label">Mobile Number</div>
                <div class="value">+<%= teacherData.country_code %> <%= teacherData.mobile %></div>
            </div>
            <div class="form-group half">
                <div class="label">Email Address</div>
                <div class="value"><%= teacherData.email %></div>
            </div>
        </div>
    </div>

    <div class="section">
        <div class="section-title">Address Details</div>
        <div class="form-row">
            <div class="form-group full">
                <div class="label">Address Line 1</div>
                <div class="value"><%= addressData.address_line_1 %></div>
            </div>
        </div>
        <% if (addressData.address_line_2) { %>
        <div class="form-row">
            <div class="form-group full">
                <div class="label">Address Line 2</div>
                <div class="value"><%= addressData.address_line_2 %></div>
            </div>
        </div>
        <% } %>
        <div class="form-row">
            <div class="form-group third">
                <div class="label">Landmark</div>
                <div class="value"><%= addressData.landmark %></div>
            </div>
            <div class="form-group third">
                <div class="label">City</div>
                <div class="value"><%= addressData.city %></div>
            </div>
            <div class="form-group third">
                <div class="label">Pincode</div>
                <div class="value"><%= addressData.pincode %></div>
            </div>
        </div>
    </div>

    <div class="section">
        <div class="section-title">Educational Qualifications</div>
        <% if (qualificationData && qualificationData.length > 0) { %>
            <table class="data-table">
                <thead>
                    <tr>
                        <th style="width: 25%">Qualification</th>
                        <th style="width: 30%">Institution</th>
                        <th style="width: 25%">Board/Univ</th>
                        <th style="width: 10%">Year</th>
                        <th style="width: 10%">Grade</th>
                    </tr>
                </thead>
                <tbody>
                    <% qualificationData.forEach(function(qual) { 
                       // Safety fallback in case individual item is still undefined
                       if(!qual) return; 
                    %>
                    <tr>
                        <td><%= qual.qualification || '-' %></td>
                        <td><%= qual.school_or_college_name || '-' %></td>
                        <td><%= qual.board_or_university || '-' %></td>
                        <td><%= qual.year || '-' %></td>
                        <td><%= qual.percentage_or_grade || '-' %></td>
                    </tr>
                    <% }); %>
                </tbody>
            </table>
        <% } else { %>
            <div class="value" style="color: #666; font-style: italic;">No qualification details provided.</div>
        <% } %>
    </div>

    <div class="section">
        <div class="section-title">Teaching Experience</div>
        <% if (experienceData && experienceData.length > 0) { %>
            <table class="data-table">
                <thead>
                    <tr>
                        <th style="width: 30%">School Name</th>
                        <th style="width: 25%">Designation</th>
                        <th style="width: 25%">Duration</th>
                        <th style="width: 20%">Total Exp</th>
                    </tr>
                </thead>
                <tbody>
                    <% experienceData.forEach(function(exp) { 
                       if(!exp) return;
                    %>
                    <tr>
                        <td><%= exp.previous_school_name || '-' %></td>
                        <td><%= exp.designation || '-' %></td>
                        <td>
                            <% if(exp.from_date && exp.to_date) { %>
                                <%= new Date(exp.from_date).toLocaleDateString() %> - 
                                <%= new Date(exp.to_date).toLocaleDateString() %>
                            <% } else { %> - <% } %>
                        </td>
                        <td>
                            <% if(exp.total_experience_in_year || exp.total_experience_in_month) { %>
                                <%= exp.total_experience_in_year || 0 %>Y <%= exp.total_experience_in_month || 0 %>M
                            <% } else { %> - <% } %>
                        </td>
                    </tr>
                    <% }); %>
                </tbody>
            </table>
        <% } else { %>
            <div class="value" style="color: #666; font-style: italic;">No previous experience listed (Fresher).</div>
        <% } %>
    </div>

    <div class="section">
        <div class="section-title">Skills & Competencies</div>
        <div class="form-row">
            <div class="form-group third">
                <div class="label">Basic Computer Knowledge</div>
                <div class="value"><%= skillsData.has_basic_computer_knowledge ? 'YES' : 'NO' %></div>
            </div>
            <div class="form-group third">
                <div class="label">MS Office Proficiency</div>
                <div class="value"><%= skillsData.know_ms_office ? 'YES' : 'NO' %></div>
            </div>
            <div class="form-group third">
                <div class="label">Online Teaching Tools</div>
                <div class="value"><%= skillsData.know_online_teaching_tools ? 'YES' : 'NO' %></div>
            </div>
        </div>
    </div>

    <div class="section">
        <div class="section-title">Declaration</div>
        <div class="declaration">
            <p>I hereby declare that the information provided in this application is true, correct, and complete to the best of my knowledge and belief. I understand that any misrepresentation or omission of facts will be grounds for immediate rejection of this application or termination of service if employed.</p>
            <br>
            <p>
                <strong>Declaration Accepted:</strong> <%= metaData.declaration_accepted ? 'YES' : 'NO' %>
            </p>
        </div>
    </div>

    <!-- ==========================================
         NEW: APPENDED DOCUMENTS SECTION
         ========================================== -->

    <% 
        let imageIndex = 0;
        const imageDocs = docData.filter(doc => {
            if (!doc || !doc.document_url) return false;
            if(doc.document_type === 'passportSizePhoto') return false;
            const url = doc.document_url.toLowerCase();
            return url.match(/\.(jpeg|jpg|gif|png|webp)($|\?)/);
        });
    %>
    <% if (imageDocs && imageDocs.length > 0) { %>
        <div class="page-break"></div>
        <div class="section">
            <div class="section-title">Uploaded Documents</div>
            
            <% imageDocs.forEach(function(doc, index) { 
                if(!doc || !doc.document_url) return;
                const url = doc.document_url.toLowerCase();
                // Simple regex to check for image extensions
                const isImage = url.match(/\.(jpeg|jpg|png|webp|heic)($|\?)/) != null;
            %>
                <div class="document-preview">
                    <h3 style="margin-bottom: 15px; color: #1E4034; border-bottom: 1px solid #eee; padding-bottom: 10px;">
                        <%= doc.document_type || 'Document ' + (index + 1) %>
                    </h3>
                    
                    <% if (isImage) { %>
                        <img src="<%= doc.document_url %>" alt="<%= doc.document_type %>">
                    <% } %>
                </div>
                
                <% if(index < imageDocs.length - 1) { %> 
                    <div class="page-break"></div> 
                <% } %>
            <% }); %>
        </div>
    <% } %>

    <div class="footer">
        <p>Generated by <%= typeof COMPANY !== 'undefined' ? COMPANY.NAME : institution.name %> System on <%= new Date().toLocaleString() %></p>
        <p>Teacher ID: <%= teacherData.registration_number %></p>
    </div>

</div>

</body>
</html>